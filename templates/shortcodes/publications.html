{# templates/shortcodes/publications.html #}

{% set raw = load_data(path="papers.json") %}

{% set_global pubs = [] %}
{% if raw.entries is defined %}
  {% for k, v in raw.entries %}
    {% set_global pubs = pubs | concat(with=[v]) %}
  {% endfor %}
{% else %}
  {% set_global pubs = raw %}
{% endif %}

{% set pubs = pubs | sort(attribute="year") | reverse %}
{% set_global last_year = -1 %}

<ul class="publications">
  {% for pub in pubs %}
    {% if last_year != pub.year %}
      <li class="year-head">{{ pub.year }}</li>
      {% set_global last_year = pub.year %}
    {% endif %}

    {% set is_preprint = (pub.status is defined and pub.status == "preprint")
                         or ((pub.journal is not defined or not pub.journal)
                             and (pub.booktitle is not defined or not pub.booktitle)
                             and (pub.arxiv is defined and pub.arxiv)) %}
    {% set v = "" %}
  {# link helpers #}
{% set has_paper_url = pub.url is defined and pub.url %}
{% set has_arxiv     = pub.arxiv is defined and pub.arxiv %}

{# is the "paper" URL actually an arXiv URL? #}
{% set url_is_arxiv = false %}
{% if has_paper_url %}
  {% if (has_arxiv and pub.url == pub.arxiv) or (pub.url is containing("arxiv.org")) %}
    {% set url_is_arxiv = true %}
  {% endif %}
{% endif %}

    {% if pub.venue is defined and pub.venue %}{% set v = pub.venue %}
    {% elif pub.journal is defined and pub.journal %}{% set v = pub.journal %}
    {% elif pub.booktitle is defined and pub.booktitle %}{% set v = pub.booktitle %}
    {% endif %}

    <li class="publication">
      <div class="pub-title">
        <a href="{{ pub.url | default(value=pub.doi) }}" class="pub-link" target="_blank" rel="noopener">
          {{ pub.title }}
        </a>
      </div>

      <div class="pub-meta">
        {% if pub.author %}
          <!-- {% for a in pub.author %}
            {% if a | lower == "victor may" %}
              <span class="me">{{ a }}</span>{% if not loop.last %}, {% endif %}
            {% else %}
              {{ a }}{% if not loop.last %}, {% endif %}
            {% endif %}
          {% endfor %} -->

          {% set limit = 5 %}
          {% for a in pub.author %}
          {% if a | lower == "victor may" %}
            {% if loop.index0 >= limit %}
            <span>, ...,</span>
            {% endif %}
            <span class="me">{{ a }}</span>{% if not loop.index0 >= limit %}, {% endif %}
          {% else %}
        {% if loop.index0 < limit %}
              {{ a }}{% if not loop.last and loop.index0 + 1 < limit %}, {% endif %}
            {% endif %}
          {% endif %}

          {% endfor %}
          {% if pub.author | length > limit %}
            <span>, ...</span>
           
          {% endif %}

        {% endif %}

        {% if v != "" %} · <span class="pub-venue">{{ v }}</span>{% endif %}
        {% if pub.year %} <span class="pub-year">({{ pub.year }})</span>{% endif %}
        {% if pub.status is defined and pub.status and pub.status != "published" %}
          <span class="pub-status">{{ pub.status }}</span>
        {% endif %}
      </div>

      <div class="pub-links">
        {# PREPRINTS: arXiv only (plus extras) #}
  {% if is_preprint %}
    {% if has_arxiv %}
      <a class="pub-badge" href="{{ pub.arxiv }}" target="_blank" rel="noopener">
        <img src="https://img.shields.io/badge/arXiv-B31B1B.svg?style=flat-square&logo=arxiv&logoColor=white" alt="arXiv">
      </a>
    {% endif %}

  {# PUBLISHED/ACCEPTED: show Paper unless it’s arXiv; still show arXiv when no camera-ready #}
  {% else %}
    {% if has_paper_url and not url_is_arxiv %}
      <a class="pub-badge" href="{{ pub.url }}" target="_blank" rel="noopener">
        <img src="https://img.shields.io/badge/Paper-%23d1495b.svg?style=flat-square&logo=readme&logoColor=white" alt="Paper">
      </a>
    {% endif %}
          {% if pub.doi %}
            <a class="pub-badge" href="https://doi.org/{{ pub.doi }}" target="_blank" rel="noopener">
              <img src="https://img.shields.io/badge/DOI-%23edae49.svg?style=flat-square&logo=doi&logoColor=white" alt="DOI">
            </a>
          {% endif %}
          {% if pub.acl %}
            <a class="pub-badge" href="{{ pub.acl }}" target="_blank" rel="noopener">
              <img src="https://img.shields.io/badge/ACL%20Anthology-%233e3e3e.svg?style=flat-square&logo=academia&logoColor=white" alt="ACL Anthology">
            </a>
          {% endif %}
          {% if pub.arxiv %}
            <a class="pub-badge" href="{{ pub.arxiv }}" target="_blank" rel="noopener">
              <img src="https://img.shields.io/badge/arXiv-B31B1B.svg?style=flat-square&logo=arxiv&logoColor=white" alt="arXiv">
            </a>
          {% endif %}
        {% endif %}

        {% if pub.github %}
          <a class="pub-badge" href="{{ pub.github }}" target="_blank" rel="noopener">
            <img src="https://img.shields.io/badge/GitHub-181717.svg?style=flat-square&logo=github&logoColor=white" alt="GitHub">
          </a>
        {% endif %}
        {% if pub.scholar %}
          <a class="pub-badge" href="{{ pub.scholar }}" target="_blank" rel="noopener">
            <img src="https://img.shields.io/badge/Google%20Scholar-4285F4.svg?style=flat-square&logo=googlescholar&logoColor=white" alt="Scholar">
          </a>
        {% endif %}
        {% if pub.twitter %}
          <a class="pub-badge" href="{{ pub.twitter }}" target="_blank" rel="noopener">
            <img src="https://img.shields.io/badge/Twitter%20thread-1DA1F2.svg?style=flat-square&logo=twitter&logoColor=white" alt="Twitter thread">
          </a>
        {% endif %}
        {% if pub.project %}
          <a class="pub-badge" href="{{ pub.project }}" target="_blank" rel="noopener">
            <img src="https://img.shields.io/badge/Project-%233e3e3e.svg?style=flat-square&logo=googlechrome&logoColor=white" alt="Project page">
          </a>
        {% endif %}
        {% if pub.dataset %}
          <a class="pub-badge" href="{{ pub.dataset }}" target="_blank" rel="noopener">
            <img src="https://img.shields.io/badge/Dataset-%23edae49.svg?style=flat-square&logo=huggingface&logoColor=white" alt="Dataset">
          </a>
        {% endif %}
        {% if pub.blog %}
          <a class="pub-badge" href="{{ pub.blog }}" target="_blank" rel="noopener">
            <img src="https://img.shields.io/badge/Blog-%23edae49.svg?style=flat-square&logo=hashnode&logoColor=white" alt="Blog post">
          </a>
        {% endif %}
        {% if pub.google_research %}
          <a class="pub-badge" href="{{ pub.google_research }}" target="_blank" rel="noopener">
            <img src="https://img.shields.io/badge/Google%20Research-%23333333.svg?style=flat-square&logo=google&logoColor=white" alt="Google Research">
          </a>
        {% endif %}
      </div>

      {% if pub.abstract %}
        <details style="margin-top:.4rem">
          <summary>Abstract</summary>
          <p>{{ pub.abstract }}</p>
        </details>
      {% endif %}

      {% if pub.bibtex %}
        <details style="margin-top:.4rem">
          <summary>BibTeX</summary>
          <button class="pub-badge" onclick="navigator.clipboard.writeText(this.nextElementSibling.innerText)">
            <img src="https://img.shields.io/badge/Copy%20BibTeX-%239a8c98.svg?style=flat-square&logo=files&logoColor=white" alt="Copy BibTeX">
          </button>
          <code class="copybox">{{ pub.bibtex }}</code>
        </details>
      {% endif %}
    </li>
  {% endfor %}
</ul>
