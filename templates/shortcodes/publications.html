{# templates/shortcodes/publications.html #}

{% set raw = load_data(path="papers.json") %}

{% set_global pubs = [] %}
{% if raw.entries is defined %}
  {% for k, v in raw.entries %}
    {% set_global pubs = pubs | concat(with=[v]) %}
  {% endfor %}
{% else %}
  {% set_global pubs = raw %}
{% endif %}

{% set pubs = pubs | sort(attribute="year") | reverse %}
{% set_global last_year = -1 %}

<ul class="publications">
  {% for pub in pubs %}
    {% if last_year != pub.year %}
      <li class="year-head">{{ pub.year }}</li>
      {% set_global last_year = pub.year %}
    {% endif %}

    {% set is_preprint = (pub.status is defined and pub.status == "preprint")
                         or ((pub.journal is not defined or not pub.journal)
                             and (pub.booktitle is not defined or not pub.booktitle)
                             and (pub.arxiv is defined and pub.arxiv)) %}
    {% set v = "" %}
    {% if pub.venue is defined and pub.venue %}{% set v = pub.venue %}
    {% elif pub.journal is defined and pub.journal %}{% set v = pub.journal %}
    {% elif pub.booktitle is defined and pub.booktitle %}{% set v = pub.booktitle %}
    {% endif %}

    <li class="publication">
      <div class="pub-title">{{ pub.title }}</div>

      <div class="pub-meta">
        {% if pub.author %}
          {% for a in pub.author %}
            {% if a | lower == "victor may" %}
              <span class="me">{{ a }}</span>{% if not loop.last %}, {% endif %}
            {% else %}
              {{ a }}{% if not loop.last %}, {% endif %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% if v != "" %} Â· <span class="pub-venue">{{ v }}</span>{% endif %}
        {% if pub.year %} <span class="pub-year">({{ pub.year }})</span>{% endif %}
        {% if pub.status is defined and pub.status and pub.status != "published" %}
          <span class="pub-status">{{ pub.status }}</span>
        {% endif %}
      </div>

      <div class="pub-links">
        {% if is_preprint %}
          {% if pub.arxiv %}
            <a class="pub-badge" href="{{ pub.arxiv }}" target="_blank" rel="noopener">
              <img src="https://img.shields.io/badge/arXiv-B31B1B.svg?style=flat-square&logo=arxiv&logoColor=white" alt="arXiv">
            </a>
          {% endif %}
        {% else %}
          {% if pub.url %}
            <a class="pub-badge" href="{{ pub.url }}" target="_blank" rel="noopener">
              <img src="https://img.shields.io/badge/Paper-%23d1495b.svg?style=flat-square&logo=readme&logoColor=white" alt="Paper">
            </a>
          {% endif %}
          {% if pub.doi %}
            <a class="pub-badge" href="https://doi.org/{{ pub.doi }}" target="_blank" rel="noopener">
              <img src="https://img.shields.io/badge/DOI-%23edae49.svg?style=flat-square&logo=doi&logoColor=white" alt="DOI">
            </a>
          {% endif %}
          {% if pub.acl %}
            <a class="pub-badge" href="{{ pub.acl }}" target="_blank" rel="noopener">
              <img src="https://img.shields.io/badge/ACL%20Anthology-%233e3e3e.svg?style=flat-square&logo=academia&logoColor=white" alt="ACL Anthology">
            </a>
          {% endif %}
          {% if pub.arxiv %}
            <a class="pub-badge" href="{{ pub.arxiv }}" target="_blank" rel="noopener">
              <img src="https://img.shields.io/badge/arXiv-B31B1B.svg?style=flat-square&logo=arxiv&logoColor=white" alt="arXiv">
            </a>
          {% endif %}
        {% endif %}

        {% if pub.github %}
          <a class="pub-badge" href="{{ pub.github }}" target="_blank" rel="noopener">
            <img src="https://img.shields.io/badge/GitHub-181717.svg?style=flat-square&logo=github&logoColor=white" alt="GitHub">
          </a>
        {% endif %}
        {% if pub.scholar %}
          <a class="pub-badge" href="{{ pub.scholar }}" target="_blank" rel="noopener">
            <img src="https://img.shields.io/badge/Google%20Scholar-4285F4.svg?style=flat-square&logo=googlescholar&logoColor=white" alt="Scholar">
          </a>
        {% endif %}
        {% if pub.twitter %}
          <a class="pub-badge" href="{{ pub.twitter }}" target="_blank" rel="noopener">
            <img src="https://img.shields.io/badge/Twitter%20thread-1DA1F2.svg?style=flat-square&logo=twitter&logoColor=white" alt="Twitter thread">
          </a>
        {% endif %}
      </div>

      {% if pub.abstract %}
        <details style="margin-top:.4rem">
          <summary>Abstract</summary>
          <p>{{ pub.abstract }}</p>
        </details>
      {% endif %}

      {% if pub.bibtex %}
        <details style="margin-top:.4rem">
          <summary>BibTeX</summary>
          <button class="pub-badge" onclick="navigator.clipboard.writeText(this.nextElementSibling.innerText)">
            <img src="https://img.shields.io/badge/Copy%20BibTeX-%239a8c98.svg?style=flat-square&logo=files&logoColor=white" alt="Copy BibTeX">
          </button>
          <code class="copybox">{{ pub.bibtex }}</code>
        </details>
      {% endif %}
    </li>
  {% endfor %}
</ul>
